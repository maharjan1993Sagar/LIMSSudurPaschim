@model LIMS.Web.Areas.Admin.Models.Bali.FarmerModel
@inject IWorkContext workContext
@{
    var roles = workContext.CurrentCustomer.CustomerRoles.Select(m => m.Name).ToList();
}
<style>
    #tal {
        width: 150%;
        overflow-x: scroll;
    }
</style>
@{
    //page title
    ViewBag.Title = "";
}
<a asp-action="CreateOne" asp-controller="Farmer"><button class="btn btn-danger">@T("Admin.Training")</button></a>
<a asp-action="Create" asp-controller="AanudanKaryakram"><button class="btn btn-outline-primary">@T("Admin.Subsidy")</button></a>
<style>
    #tal {
        width: 150%;
        overflow-x: scroll;
    }
</style>
<form asp-area="@Constants.AreaAdmin" asp-controller="Farmer" asp-action="CreateOne" method="post">

    <div class="row">
        <div class="col-md-12">
            <div class="x_panel light form-fit">
                <div class="x_title">
                    <div class="caption">
                        <i class="fa fa-comment"></i>
                        @T("Admin.IncubationCenter.Create")
                    </div>

                </div>
                <vc:admin-widget widget-zone="blog_details_buttons" additional-data="null" />

                <div class="x_content form">
                    <div class="x_content form">
                        <div class="form-row">
                            <div class="col-md-3">

                                <div class="form-group">
                                    <admin-label asp-for="FiscalYearId" />
                                    <admin-select asp-for="FiscalYearId" asp-items="ViewBag.FiscalYearId" required="required">
                                    </admin-select>
                                    <span asp-validation-for="FiscalYearId"></span>
                                </div>
                            </div>
                            <div class="col-md-3">

                                <div class="form-group">
                                    <admin-label asp-for="budgetId" />
                                    <select asp-for="budgetId" asp-items="@ViewBag.budgetId" data-val="@Model.budgetId" class="form-control" required="required"></select>
                                    <span asp-validation-for="budgetId"></span>
                                </div>
                            </div>
                            <div class="col-md-3">

                                <div class="form-group">
                                    <admin-label asp-for="TalimId" />
                                    <select asp-for="TalimId" data-val="@Model.TalimId" class="form-control" required="required"></select>
                                    <span asp-validation-for="TalimId"></span>
                                </div>
                            </div>
                            <div class="col-md-2">

                                <div class="form-group">
                                    <admin-label asp-for="LocalLevel" />
                                    <input type="hidden" asp-for="LocalLevel" />
                                    <select name="LocalLevel1" data-val="@Model.LocalLevel" asp-items="@ViewBag.LocalLevels" class="form-control" required="required">
                                    </select>
                                    <span asp-validation-for="LocalLevel"></span>
                                </div>
                            </div>
                            <div class="result">
                                <div class="row text-center">
                                    <b>नेपाल सरकार</b><br />
                                    <b><label id="LocalLevel"></label></b><br />
                                    <b><label id="Addres"></label></b>
                                    <div class="col-md-4"><label id="StartDate"></label> </div>
                                    <div class="col-md-4"><label id="EndDate"></label></div>
                                    <div class="col-md-4"><label id="TotalExpense"></label></div>
                                    <div class="col-md-12"><label id="Logistics"></label></div>
                                    <div class="col-md-12"><label id="Purpose"></label></div>
                                    <div class="col-md-12"><label id="Remarks"></label></div>
                                </div>
                                <table class="table table-bordered">
                                    <tr style="text-align:center">
                                        <th>
                                            <admin-label asp-for="Name" />
                                        </th>

                                        <th>
                                            <admin-label asp-for="Address" />
                                        </th>

                                        <th>
                                            <admin-label asp-for="WardNo" />
                                        </th>
                                        <th>
                                            <admin-label asp-for="Phone" />
                                        </th>
                                        <th><admin-label asp-for="Gender" /></th>
                                        <th><admin-label asp-for="Caste" /></th>

                                    </tr>
                                    <tbody id="tabularEntry">
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</form>
<button id="btnExport" class="btn btn-primary" onclick="Export()">Export</button>
<script src="~/scripts/jquery.table2excel.js"></script>

<script>
    $(document).ready(function () {
        var fiscalyear = $("#@Html.IdFor(m=>m.FiscalYearId)").val();
        var budgetId = $("#@Html.IdFor(m=>m.budgetId)").val();
        var localLevel =$("#@Html.IdFor(m=>m.LocalLevel)").val();

        datas = {
            fiscalyear: fiscalyear,
            budgetId: budgetId
        }

        if (fiscalyear) {
            var a = $("#@Html.IdFor(m=>m.budgetId)").data('val');
                 $("#@Html.IdFor(m=>m.budgetId)").empty();
                 $("#@Html.IdFor(m=>m.budgetId)").append(`<option value="">Select</option>`);

                 url = "/Admin/LabambitKrishak/GetBudget";
                 $.getJSON(url, datas, function (result) {
                     $.each(result, function (i, item) {
                         if (a == item.Id) {
                             $("#@Html.IdFor(m=>m.budgetId)").append(`<option value="${item.Id}" selected>${item.ActivityName}</option>`);
                         }
                         else {
                             $("#@Html.IdFor(m=>m.budgetId)").append(`<option value="${item.Id}">${item.ActivityName}</option>`);
                         }
                         });
                 })
        }

        if (budgetId) {
            var a = $("#@Html.IdFor(m=>m.TalimId)").data('val');
                 $("#@Html.IdFor(m=>m.TalimId)").empty();
                 $("#@Html.IdFor(m=>m.TalimId)").append(`<option value="">Select</option>`);

                 url = "/Admin/LabambitKrishak/GetTrainingProgram";
                 $.getJSON(url, datas, function (result) {
                     $.each(result, function (i, item) {
                         if (a == item.Id) {
                             $("#@Html.IdFor(m=>m.TalimId)").append(`<option value="${item.Id}" selected>${item.NameNepali}</option>`);
                         }
                         else {
                             $("#@Html.IdFor(m=>m.TalimId)").append(`<option value="${item.Id}">${item.NameNepali}</option>`);
                         }
                         });
                 })
        }

          data = {
            fiscalyear:$("#@Html.IdFor(m=>m.FiscalYearId)").val(),
            budgetId:$("#@Html.IdFor(m=>m.budgetId)").val(),
            localLevel: $("#@Html.IdFor(m=>m.LocalLevel)").val(),
            talimId: $("#@Html.IdFor(m=>m.TalimId)").val(),
                }
        abc(data);
    });

        $("#@Html.IdFor(m=>m.FiscalYearId)").change(function () {
             fiscalyear = $(this).val();
             data = {
            fiscalyear:$("#@Html.IdFor(m=>m.FiscalYearId)").val(),
            budgetId:$("#@Html.IdFor(m=>m.budgetId)").val(),
            localLevel:$("#@Html.IdFor(m=>m.LocalLevel)").val(),
            talimId:$("#@Html.IdFor(m=>m.TalimId)").val(),
            }

             if (fiscalyear) {
                 $("#@Html.IdFor(m=>m.budgetId)").empty();
                 $("#@Html.IdFor(m=>m.budgetId)").append(`<option value="">Select</option>`);

                 url = "/Admin/LabambitKrishak/GetBudget";
                 $.getJSON(url, data, function (result) {
                     $.each(result, function (i, item) {
                         $("#@Html.IdFor(m=>m.budgetId)").append(`<option value="${item.Id}">${item.ActivityName}</option>`);
                     });
                 })
            }
            abc(data);
        });

    $("#@Html.IdFor(m=>m.budgetId)").change(function () {
        budgetId = $(this).val();
        data = {
           fiscalyear:$("#@Html.IdFor(m=>m.FiscalYearId)").val(),
            budgetId:$("#@Html.IdFor(m=>m.budgetId)").val(),
            localLevel: $("#@Html.IdFor(m=>m.LocalLevel)").val(),
            talimId:$("#@Html.IdFor(m=>m.TalimId)").val()
        }
        if (budgetId) {
                 $("#@Html.IdFor(m=>m.TalimId)").empty();
                 $("#@Html.IdFor(m=>m.TalimId)").append(`<option value="">Select</option>`);

            url = "/Admin/LabambitKrishak/GetTrainingProgram";
                 $.getJSON(url, data, function (result) {
                     $.each(result, function (i, item) {
                         $("#@Html.IdFor(m=>m.TalimId)").append(`<option value="${item.Id}">${item.NameNepali}</option>`);
                     });
                 })
            }
        abc(data);
    });
      $("#@Html.IdFor(m=>m.TalimId)").change(function () {
        data = {
            fiscalyear:$("#@Html.IdFor(m => m.FiscalYearId)").val(),
            budgetId:$("#@Html.IdFor(m=>m.budgetId)").val(),
            localLevel: $("#@Html.IdFor(m=>m.LocalLevel)").val(),
            talimId:  $("#@Html.IdFor(m=>m.TalimId)").val()
        }
        abc(data);
      });

      $("#@Html.IdFor(m=>m.LocalLevel)").change(function () {
        data = {
            fiscalyear:$("#@Html.IdFor(m=>m.FiscalYearId)").val(),
            budgetId:$("#@Html.IdFor(m=>m.budgetId)").val(),
            localLevel: $("#@Html.IdFor(m=>m.LocalLevel)").val(),
            talimId:  $("#@Html.IdFor(m=>m.TalimId)").val()
        }
        abc(data);
      });

    function abc(data) {
        $(tabularEntry).html("");
        if (data.fiscalyear && data.budgetId && data.talimId && data.localLevel) {
            $.post("@Url.Action("GetTalimDataNew", "Farmer")", addAntiForgeryToken(data), function (result) {
                if (result.length > 0) {                   
                    // Convert date strings to Date objects and format them for input fields
                    var d = new Date(Date.parse(result[0].StartDate));
                    var startDate = d.getFullYear() + "-" + ("0" + (d.getMonth() + 1)).slice(-2) + "-" + ("0" + d.getDate()).slice(-2);

                    var dA = new Date(Date.parse(result[0].EndDate));
                    var endDate = dA.getFullYear() + "-" + ("0" + (dA.getMonth() + 1)).slice(-2) + "-" + ("0" + dA.getDate()).slice(-2);

                    $("#@Html.IdFor(m => m.StartDate)").val(startDate);
                    $("#@Html.IdFor(m => m.EndDate)").val(endDate);
                    $("#@Html.IdFor(m=>m.LocalLevel)").val(data.localLevel);
                    $("#@Html.IdFor(m=>m.TotalExpense)").val(result[0].TotalExpenses);
                    $("#@Html.IdFor(m=>m.Logistics)").val(result[0].Logistics);
                    $("#@Html.IdFor(m=>m.Purpose)").val(result[0].Purpose);
                    $("#@Html.IdFor(m=>m.Remarks)").val(result[0].Remarks);

                    $.each(result, function (index, item) {

                        var tableRow = '<tr><td>'+item.Name+'</td>';
                        tableRow += '<td>' + item.Address + '</td>';
                        tableRow += '<td>' + item.Ward + '</td>';
                        tableRow += '<td>' + item.Phone + '</td>';
                        tableRow += '<td>' + item.Gender + '</td>';
                        tableRow += '<td>' + item.Caste + '</td></tr>';
                        $(tabularEntry).append(tableRow);

                    });

                }
    else
    {
        $("#result").hide();
    }

            });
        }
        else
        {
                   $("#result").hide();
        }

    }


    function Export() {
        $(".table").table2excel({
            filename: "Training.xls"
        });
    }
</script>
